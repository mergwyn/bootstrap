#!/usr/bin/env bash

# Script to initialise openwrt for nordvpn
set -o nounset
set -o pipefail
set -o errexit

readonly openvpn=/etc/openvpn
readonly api="https://api.nordvpn.com/v1/servers/recommendations"
_updated=


getsecret() {
  eyaml decrypt -e /usr/src/control-repo/data/secrets.yaml |
    sed -n -e "/secrets::$1:/"'s/^.*PKCS7\[\(.*\)\]!/\1/p'
}

opkg_update() {
  if [[ -z "${_updated}" ]] ; then
    opkg update
    _updated=true
  fi
}

install_packages() {
  local -a packages
  packages=(
    bash
    jq
    curl
    coreutils-shuf
    miniupnpd
    snmpd
  )

  opkg_update
  opkg install "${packages[@]}" 
}

# Install openvpn and luci module
install_openvpn() {
  local -a packages
  packages=(
    openvpn-openssl
    ip-full
    luci-app-openvpn
    bind-dig
    dnsmasq-full
    vpn-policy-routing
    luci-app-vpn-policy-routing
    luci-app-sqm
  )
  opkg_update
  opkg install "${packages[@]}" 

  /etc/init.d/openvpn enable
}

# Create a file for authentication
configure_openvpn() {
  {
    getsecret nordvpn::user
    getsecret nordvpn::password
  } | sh -c "cat > $openvpn/secret" 

  sh -c "cat > $openvpn/nordvpn.conf" <<!
config ${openvpn}/fastest.server
auth-user-pass ${openvpn}/secret
!

  uci set openvpn.nordvpn=openvpn
  uci set openvpn.nordvpn.enabled='1'
  uci set openvpn.nordvpn.config="${openvpn}/nordvpn.conf"
  uci commit openvpn

}

nordvpn_server() {

  recommended=$(curl --silent "${api}" | jq --raw-output 'limit(1;.[]) | .hostname')
  config=${recommended%%.*}.nordvpn.com.udp.ovpn

  [[ -f /tmp/"${config}" ]] ||
    curl -qs "https://downloads.nordcdn.com/configs/files/ovpn_udp/servers/$config" -o /tmp/"${config}"
  mkdir $openvpn/config
  lxc file push "/tmp/$config" "${guest}/${openvpn}/config/"
  sh -c "cat > $openvpn/fastest.server" <<!
config ${openvpn}/config/$config
!
}

network_base() {
  uci set network.lan=interface
  uci set network.lan.ifname='eth0'
  uci set network.lan.proto='static'
  uci set network.lan.netmask='255.255.255.0'
  uci set network.lan.ip6assign='60'
  uci set network.lan.ipaddr='192.168.11.251'

  uci set network.wan=interface
  uci set network.wan.ifname='eth1'
  uci set network.wan.proto='dhcp'

  uci set network.wan.ifname='eth1'

# configure the DNS servers:
  uci set network.wan.peerdns='0'
  uci del network.wan.dns || true
  uci add_list network.wan.dns='103.86.96.100'
  uci add_list network.wan.dns='103.86.99.100'

  uci set 'network.lan.ipv6=off'
  uci set 'network.wan.ipv6=off'

  uci commit network

  uci set dhcp.@dnsmasq[0].domain='theclarkhome.com'
  uci set dhcp.@dnsmasq[0].local='/theclarkhome.com/192.168.11.21'
  uci del dhcp.@dnsmasq[0].server || true
  uci add_list dhcp.@dnsmasq[0].server='/theclarkhome.com/192.168.11.22'
  uci add_list dhcp.@dnsmasq[0].server='103.86.96.100'
  uci add_list dhcp.@dnsmasq[0].server='103.86.99.100'
  #uci set dhcp.@dnsmasq[0].cachesize='0'
  uci del dhcp.@dnsmasq[0].rebind_domain || true
  uci add_list dhcp.@dnsmasq[0].rebind_domain='theclarkhome.com'
  #uci add_list dhcp.@dnsmasq[0].rebind_domain='bbc.co.uk'
  uci add_list dhcp.@dnsmasq[0].rebind_domain='plex.direct'

  uci set dhcp.lan.ignore='1'
  uci set dhcp.wan.ignore='1'

  uci set 'dhcp.lan.dhcpv6=disabled'
  /etc/init.d/odhcpd disable

  uci commit dhcp
  /etc/init.d/dnsmasq restart

  sleep 15
}

network_sqm() {
  WAN_NAME=$1
  WAN_IFACE=$(uci get "network.${WAN_NAME}.ifname")
  BW_DOWN='110'
  BW_UP='9'

  uci del sqm.eth1 || true
  uci del sqm."${WAN_NAME}" || true

  uci set sqm."${WAN_NAME}"='queue'
  uci set sqm."${WAN_NAME}".interface="$WAN_IFACE"
  uci set sqm."${WAN_NAME}".download=$((BW_DOWN*1000*85/100))
  uci set sqm."${WAN_NAME}".upload=$((BW_UP*1000*85/100))
  uci set sqm."${WAN_NAME}".qdisc='cake'
  uci set sqm."${WAN_NAME}".script='piece_of_cake.qos'
  uci set sqm."${WAN_NAME}".linklayer='ethernet'
  uci set sqm."${WAN_NAME}".overhead='44'
  uci set sqm."${WAN_NAME}".qdisc_advanced='0' # Default '0'
  uci set sqm."${WAN_NAME}".debug_logging='1'
  uci set sqm."${WAN_NAME}".verbosity='5'
  uci set sqm."${WAN_NAME}".enabled='1'

  uci commit sqm

  /etc/init.d/sqm restart
}

network_openvpn() {
  uci set network.nordvpntun=interface
  uci set network.nordvpntun.proto='none'
  uci set network.nordvpntun.ifname='tun0'

  uci commit network

  network_sqm nordvpntun
  network_sqm wan
}

# Create a new firewall zone and add a forwarding rule from LAN to VPN:
vpn_firewall() {
  uci add firewall zone
  uci set firewall.@zone[-1].name='vpnfirewall'
  uci set firewall.@zone[-1].input='REJECT'
  uci set firewall.@zone[-1].output='ACCEPT'
  uci set firewall.@zone[-1].forward='REJECT'
  uci set firewall.@zone[-1].masq='1'
  uci set firewall.@zone[-1].mtu_fix='1'
  uci add_list firewall.@zone[-1].network='nordvpntun'
  uci add firewall forwarding
  uci set firewall.@forwarding[-1].src='lan'
  uci set firewall.@forwarding[-1].dest='vpnfirewall'

  uci add firewall redirect
  uci set firewall.@redirect[-1].dest_port='32400'
  uci set firewall.@redirect[-1].src='wan'
  uci set firewall.@redirect[-1].name='Plex'
  uci set firewall.@redirect[-1].src_dport='32400'
  uci set firewall.@redirect[-1].target='DNAT'
  uci set firewall.@redirect[-1].dest='lan'

  uci commit firewall

}


vpn-policy-routing () {

  uci set vpn-policy-routing.@include[-1]=include
  uci set vpn-policy-routing.@include[-1].path='/etc/vpn-policy-routing.aws.user'
  uci set vpn-policy-routing.@include[-1]=include
  uci set vpn-policy-routing.@include[-1].path='/etc/vpn-policy-routing.netflix.user'
  uci set vpn-policy-routing.@include[-1]=include
  uci set vpn-policy-routing.@include[-1].enabled='0'
  uci set vpn-policy-routing.@include[-1].path='/etc/vpn-policy-routing.bbc.user'
  uci set vpn-policy-routing.@include[-1]=include
  uci set vpn-policy-routing.@include[-1].enabled='1'
  uci set vpn-policy-routing.@include[-1].path='/etc/vpn-policy-routing.plex.user'
  uci set vpn-policy-routing.config=vpn-policy-routing
  uci set vpn-policy-routing.config.verbosity='2'
  uci set vpn-policy-routing.config.strict_enforcement='1'
  uci set vpn-policy-routing.config.src_ipset='0'
  uci set vpn-policy-routing.config.dest_ipset='dnsmasq.ipset'
  uci set vpn-policy-routing.config.ipv6_enabled='0'
  uci set vpn-policy-routing.config.supported_interface=''
  uci set vpn-policy-routing.config.ignored_interface='vpnserver wgserver'
  uci set vpn-policy-routing.config.boot_timeout='30'
  uci set vpn-policy-routing.config.iptables_rule_option='append'
  uci set vpn-policy-routing.config.iprule_enabled='0'
  uci set vpn-policy-routing.config.webui_enable_column='0'
  uci set vpn-policy-routing.config.webui_protocol_column='0'
  uci set vpn-policy-routing.config.webui_chain_column='0'
  uci set vpn-policy-routing.config.webui_sorting='1'
  uci set vpn-policy-routing.config.webui_supported_protocol='tcp' 'udp' 'tcp udp' 'icmp' 'all'
  uci set vpn-policy-routing.config.enabled='1'
  uci set vpn-policy-routing.@policy[-1]=policy
  uci set vpn-policy-routing.@policy[-1].comment='Plex Remote Servers'
  uci set vpn-policy-routing.@policy[-1].interface='wan'
  uci set vpn-policy-routing.@policy[-1].dest_addr='plex.tv my.plexapp.com'

  uci commit vpn-policy-routing

}

vpn_prevent_leak() {
  sh -c "cat > /etc/firewall.user" <<!
# This file is interpreted as a shell script.
# Put your custom iptables rules here, and they will be executed with each firewall (re-)start
# Internal uci firewall chains are flushed and recreated on reload, so
# put custom rules into the root chains, e.g. INPUT or FORWARD, or into the
# special user chains, e.g. input_wan_rule or postrouting_lan_rule.

if (! ip a s tun0 up) && (! iptables -C forwarding_rule -j REJECT); then
       iptables -I forwarding_rule -j REJECT
fi
!

  sh -c "cat > /etc/hotplug.d/iface/99-prevent-leak" <<!
#!/bin/sh
if [ "\$ACTION" = ifup ] && (ip a s tun0 up) && (iptables -C forwarding_rule -j REJECT); then
       iptables -D forwarding_rule -j REJECT
fi
if [ "\$ACTION" = ifdown ] && (! ip a s tun0 up) && (! iptables -C forwarding_rule -j REJECT); then
       iptables -I forwarding_rule -j REJECT
fi
!
}

snmpd() {
  uci set snmpd.@system[0]=system
  uci set snmpd.@system[0].sysLocation='undisclosed'
  uci set snmpd.@system[0].sysContact='OpenWRT router <openwrt@openwrt.org>'
  uci set snmpd.@system[0].sysName="${guest}"
}

create_container() {
  local password
  lxc init images:openwrt/19.07 "${guest}"

  lxc config device add "${guest}" eth1 nic name=eth1 nictype=bridged parent=lxdbr0

  lxc start "${guest}"
  password=$(getsecret openwrt)
  printf '%s\n%s' "${password}" "${password}" | lxc exec "${guest}" -- passwd
}

full_install() {
  create_container
  network_base
  install_packages
  snmpd

  install_openvpn
  configure_openvpn
  nordvpn_server
  network_openvpn
  vpn_firewall
  vpn_prevent_leak

  /etc/init.d/openvpn start
  sleep 5
}

[[ $# -lt 1 ]] && Usage

commands=("$@")
if [[ ${#commands[@]} = 0 ]] ; then
  full_install
else
  for commands in "${commands[@]}"; do
    $command
  done
fi
